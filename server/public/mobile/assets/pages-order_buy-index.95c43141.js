import{o as e,c as a,w as t,b as s,e as l,f as o,F as n,j as r,d as i,v as c,r as u,a as d,h as p,k as f,t as m,D as y,q as _,a9 as b,u as v,bj as g,bk as x,a3 as h,bl as w,b8 as k,bm as P,bn as j,bo as C,aA as E,bp as R,aW as I,af as A,ao as S,W,bq as H,s as T,a4 as $,ae as z,ag as L,g as V,az as G,m as O,p as q}from"./index.0909ac6c.js";import{_ as D}from"./u-count-down.9a1490e6.js";import{_ as F}from"./u-button.a01fb808.js";import{_ as M}from"./u-popup.7b59164b.js";import{P as N}from"./index.5b25a2dc.js";import{_ as U}from"./plugin-vue_export-helper.21dcd24c.js";import{_ as X}from"./u-icon.0b85921a.js";import{t as B,a as J}from"./tabs.b16c84eb.js";import{o as K}from"./coupon.c29ff76c.js";import{c as Q}from"./index.2c7f59b4.js";import"./u-badge.2b611478.js";import"./u-sticky.c3d66a2b.js";import"./useTouch.93885aba.js";var Y=U({},[["render",function(i,c){const u=r;return e(),a(u,{class:"skeleton"},{default:t((()=>[s(u,{class:"payinfo-skt"},{default:t((()=>[s(u,{class:"money base-bg"}),s(u,{class:"time base-bg"})])),_:1}),s(u,{class:"methods-skt base-margin"},{default:t((()=>[s(u,{class:"methods--title base-bg"}),(e(),l(n,null,o(2,(e=>s(u,{class:"methods--item flex-col col-center",key:e},{default:t((()=>[s(u,{class:"methods--item--text base-bg"}),s(u,{class:"methods--item--icon base-bg"})])),_:2},1024))),64))])),_:1}),s(u,{class:"line-skt base-bg"}),s(u,{class:"special-skt flex row-between"},{default:t((()=>[s(u,{class:"special-text base-bg"}),s(u,{class:"special-icon base-bg"})])),_:1})])),_:1})}],["__scopeId","data-v-27002186"]]);var Z=U(i({__name:"couponCom",props:{payment:{type:Object,default:{}},getPrice:{type:Function,default:()=>{}}},setup(i,{expose:v}){const g=i,x=c(0),h=c(!1),w=c(""),k=c(""),P=c({avaliable:{name:"可用优惠券",data:[]},unavaliable:{name:"不可用优惠券",data:[]}}),j=()=>{if(0!=P.value.avaliable.data.length)try{C(P.value.avaliable.data[0],0),E()}catch(e){console.log(e)}},C=(e,a)=>{1!=a&&(w.value.coupon_list_id!=e.coupon_list_id?w.value=e:w.value="")},E=async()=>{k.value=w.value,g.getPrice(k.value.coupon_list_id),h.value=!1};return v({initCoupon:()=>{(async()=>{const{unusable:e,usable:a}=await K({order_id:g.payment.order_id});P.value.avaliable.data=a,P.value.unavaliable.data=e,j()})()}}),(i,c)=>{const v=r,g=u(d("u-icon"),X),j=y,R=_,I=u(d("tab"),B),A=u(d("tabs"),J),S=b,W=u(d("u-popup"),M);return e(),l(n,null,[p(' <view\n                class="coupon flex p-[30rpx] justify-between"\n                style="border-bottom: 1px solid #f6f6f6"\n                @click="couponPop = true"\n                v-if="payment.orderType != PayEnum.RECHARGE"\n            > '),s(v,{class:"coupon flex p-[30rpx] justify-between",style:{"border-bottom":"1px solid #f6f6f6"},onClick:c[0]||(c[0]=e=>h.value=!0)},{default:t((()=>[s(v,null,{default:t((()=>[f("优惠券")])),_:1}),""==k.value?(e(),a(v,{key:0,class:"flex"},{default:t((()=>[P.value.avaliable.data.length?(e(),a(v,{key:1,class:"mr-[10rpx]"},{default:t((()=>[f(m(`${P.value.avaliable.data.length||"无"}张优惠券可用`),1)])),_:1})):(e(),a(v,{key:0,class:"mr-[10rpx]"},{default:t((()=>[f("暂无可用的优惠券")])),_:1})),s(g,{name:"arrow-right",color:"#666666",size:"28"})])),_:1})):p("v-if",!0),""!=k.value?(e(),a(v,{key:1,class:"flex"},{default:t((()=>[s(v,{class:"mr-[10rpx] text-[#FA8919]"},{default:t((()=>[f(m(`-¥${k.value.money}`),1)])),_:1}),s(g,{name:"arrow-right",color:"#666666",size:"28"})])),_:1})):p("v-if",!0)])),_:1}),s(W,{modelValue:h.value,"onUpdate:modelValue":c[1]||(c[1]=e=>h.value=e),mode:"bottom",height:"850rpx",borderRadius:"14","safe-area-inset-bottom":"",closeable:""},{default:t((()=>[s(v,{class:"px-[30rpx]"},{default:t((()=>[s(v,{class:"title py-[25rpx] h-[100rpx] text-center text-3xl sticky top-0 bg-white"},{default:t((()=>[f("优惠")])),_:1}),s(v,null,{default:t((()=>[s(A,{isScroll:!1,current:x.value,height:"80",showBar:!1},{default:t((()=>[(e(!0),l(n,null,o(P.value,((r,i,c)=>(e(),a(I,{key:c,name:`${r.name}(${r.data.length})`},{default:t((()=>[s(v,{class:"tabH"},{default:t((()=>[s(R,{"scroll-y":"",class:"h-full"},{default:t((()=>[(e(!0),l(n,null,o(r.data,((l,o)=>(e(),a(v,{key:o,class:"py-[15rpx]",onClick:e=>C(l,c)},{default:t((()=>[s(Q,{"is-select-coupon":w.value.coupon_list_id==l.coupon_list_id,disabled:1==c,"coupon-data":l,type:2},null,8,["is-select-coupon","disabled","coupon-data"])])),_:2},1032,["onClick"])))),128)),0==r.data.length?(e(),a(v,{key:0,class:"flex flex-col items-center justify-center h-full"},{default:t((()=>[s(j,{src:"/mobile/assets/collection.88a1e823.png",class:"w-[200rpx] h-[200rpx]"}),s(v,null,{default:t((()=>[f("暂无数据～")])),_:1})])),_:1})):p("v-if",!0)])),_:2},1024)])),_:2},1024)])),_:2},1032,["name"])))),128))])),_:1},8,["current"])])),_:1}),s(v,{class:"h-[100rpx]"},{default:t((()=>[s(S,{class:"bg-primary rounded-[100rpx] text-white",onClick:E},{default:t((()=>[f(" 确定 ")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-5ea9ba48"]]);function ee(){const e=c(!0),a=h({from:"",order_id:"",cancelTime:0,payWayLists:[],orderAmount:"",couponId:""}),t=async e=>{try{return k()==E.H5?await(async e=>{v(),await g({MP_WEIXIN:()=>new Promise(((a,t)=>{console.log(e,"weixin"),uni.requestPayment({provider:"wxpay",timeStamp:e.timeStamp,nonceStr:e.nonceStr,package:e.package,signType:e.signType,paySign:e.paySign,success:e=>a(e),cancel:e=>t(e),fail:e=>t(e)})})),OA_WEIXIN:()=>x(e),H5:()=>new Promise(((a,t)=>{const s=e+"&redirect_url="+encodeURIComponent(window.location.href+"&showPop=1");window.open(s,"_self")})),APP:()=>new Promise(((a,t)=>{uni.requestPayment({provider:"wxpay",orderInfo:e,success:e=>a(e),cancel:e=>t(e),fail:e=>t(e)})}))})})(e.config):await x(e.config),!0}catch(a){return P("支付取消"),console.log("微信支付失败",a),!1}},s=async()=>!0,l=e=>{if(k()!=E.H5){if(a.from==R.RECHARGE&&e)return I("payment"),void A();if(a.from==R.ORDER&&e)return void S({url:`/bundle/pages/pay_result/index?orderId=${a.order_id}`});const t=W();if("pages/course_detail/index"===t[t.length-2].route)S({url:"/bundle/pages/order_list/index"});else A()}else{if(a.from==R.RECHARGE)return e?(I("payment"),void S({url:"/bundle/pages/user_charge/index"})):void S({url:"/bundle/pages/user_charge/index"});if(a.from==R.ORDER)return e?void S({url:`/bundle/pages/pay_result/index?orderId=${a.order_id}`}):void S({url:"/bundle/pages/order_list/index"})}};return{loading:e,payment:a,initPayWay:async(t,s)=>{try{a.order_id=t,a.from=s;const{cancel_time:l,lists:o,order_amount:n}=await w({from:s,order_id:t,scene:k()});a.cancelTime=parseInt(String(1e3*l-(new Date).getTime())),a.payWayLists=o,a.orderAmount=n,e.value=!1}catch(l){P("错误：",l)}},handlePayPrepay:async e=>{try{const o=await j({from:a.from,pay_way:e,order_id:a.order_id,coupon_list_id:a.couponId});console.log(o,{from:a.from,pay_way:e,order_id:a.order_id,coupon_list_id:a.couponId},123);let n=null;switch(1*e){case C.WALLET:n=await s();break;case C.WECHAT:n=await t(o);break;default:throw"支付方式不对"}l(n)}catch(o){P(o),console.log("预支付",o)}},handlePayResult:l,getPrice:async(e="")=>{a.couponId=e;const{order_amount:t}=await H({from:a.from,order_id:a.order_id,coupon_list_id:e});a.orderAmount=t}}}var ae=U(i({__name:"index",setup(i){const _=T(),b=$(),v=c(!1),g=c(0),{loading:x,initPayWay:h,handlePayPrepay:w,payment:k,handlePayResult:P,getPrice:j}=ee();z((()=>k.payWayLists),(e=>{var a;g.value=null==(a=e[0])?void 0:a.pay_way}));const C=()=>{uni.$u.debounce(E,500)},E=()=>{if(1!=g.value||0!=b.$state.userInfo.is_auth)try{w(g.value)}catch(e){console.log("预支付调用",e)}else v.value=!0},I=async e=>{k.cancelTime<0||await G({title:"温馨提示",showCancel:!1,content:"当前订单支付时间已过，请重新下单",success:()=>{A()}})};return L((async e=>{const{order_id:a,from:t}=JSON.parse(e.params);1==e.showPop&&G({title:"提示",content:"请确认是否已完成支付？",success:e=>{e.confirm?P(!0):e.cancel&&P(!1)}}),await h(a,t),console.log(a,t),_.value.initCoupon()})),(i,c)=>{const b=q,h=u(d("u-count-down"),D),w=r,P=y,E=u(d("u-button"),F),A=u(d("u-popup"),M);return e(),a(w,{class:"payment"},{default:t((()=>[p(" Header Start "),s(w,{class:"header"},{default:t((()=>[s(N,{content:V(k).orderAmount,mainSize:"44rpx",minorSize:"34rpx",fontWeight:"500",color:"#ffffff"},null,8,["content"]),V(k).cancelTime>0&&V(k).from!=V(R).RECHARGE?(e(),a(w,{key:0,class:"flex justify-center text-white mt-[20rpx] font-xs"},{default:t((()=>[s(b,{class:"mr-[10rpx]"},{default:t((()=>[f("请在")])),_:1}),s(h,{timestamp:V(k).cancelTime,onEnd:I,format:"mm:ss","font-size":22},null,8,["timestamp"]),s(b,{class:"ml-[10rpx]"},{default:t((()=>[f("内进行支付")])),_:1})])),_:1})):p("v-if",!0)])),_:1}),p(" Header End "),p(" Main Start "),s(w,{class:"main bg-white"},{default:t((()=>[V(k).from!=V(R).RECHARGE?(e(),a(Z,{key:0,ref_key:"couponComRef",ref:_,payment:V(k),"get-price":V(j)},null,8,["payment","get-price"])):p("v-if",!0),s(w,{class:"title"},{default:t((()=>[f("支付方式")])),_:1}),p(" 支付方式 "),s(w,{class:"payway"},{default:t((()=>[(e(!0),l(n,null,o(V(k).payWayLists,((l,o)=>(e(),a(w,{class:"payway-item",onClick:e=>{return a=l.pay_way,void(g.value=a);var a},key:o},{default:t((()=>[s(P,{class:"payway-item--icon",src:l.image},null,8,["src"]),s(w,{class:"payway-item--name flex-1"},{default:t((()=>[f(m(l.name),1)])),_:2},1024),s(w,{class:"payway-item--select"},{default:t((()=>[g.value===l.pay_way?(e(),a(P,{key:0,src:"/mobile/static/images/icon_select.png"})):p("v-if",!0)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),s(w,{class:"submit-btn"},{default:t((()=>[s(E,{onClick:C,ripple:!0,shape:"circle","hair-line":!1,type:"primary"},{default:t((()=>[f("立即支付")])),_:1})])),_:1})])),_:1}),s(A,{modelValue:v.value,"onUpdate:modelValue":c[2]||(c[2]=e=>v.value=e),mode:"center",borderRadius:"14","mask-close-able":!1},{default:t((()=>[s(w,{class:"course-pop text-center"},{default:t((()=>[s(w,{class:"text-lg font-medium normal pt-[45rpx] pb-[40rpx]"},{default:t((()=>[f("抱歉，您还未绑定微信")])),_:1}),s(w,{class:"flex justify-between mt-[60rpx]"},{default:t((()=>[s(E,{onClick:c[0]||(c[0]=e=>{O({url:"/pages/user_set/user_set"})}),class:"flex-1",ripple:!0,shape:"circle","hair-line":!1,type:"primary"},{default:t((()=>[f("去绑定")])),_:1}),s(E,{onClick:c[1]||(c[1]=e=>v.value=!1),class:"flex-1 m-l-30",ripple:!0,shape:"circle","hair-line":!1,type:"gary"},{default:t((()=>[f("取消")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),p(" Main End "),V(x)?(e(),a(Y,{key:0})):p("v-if",!0)])),_:1})}}}),[["__scopeId","data-v-247ee618"]]);export{ae as default};
